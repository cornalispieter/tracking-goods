<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tracking Goods App</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 1rem; background: #f3f4f6; }
    h1 { text-align: center; margin-bottom: 1rem; }
    .container { max-width: 700px; margin: auto; background: #fff; padding: 1rem; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}    
    label { display:block; margin-top: .5rem; }
    input { width:100%; padding:.5rem; margin-top:.3rem; }
    button { margin-top:1rem; padding:.7rem; width:100%; border:none; border-radius:8px; background:#2563eb; color:white; font-size:1rem; cursor:pointer; }
    button:hover { background:#1e4ecf; }
    table { width:100%; margin-top:1rem; border-collapse:collapse; }
    th, td { border-bottom:1px solid #ddd; padding:.6rem; text-align:left; }
    tr:hover { background:#f0f0f0; }
    .actions button { margin:0 .2rem; padding:.4rem .6rem; width:auto; }
    #historyModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); justify-content:center; align-items:center; }
    #historyBox { background:#fff; padding:1rem; border-radius:8px; max-width:500px; width:90%; }
    #closeHistory { background:#ef4444; }
    @media(max-width:480px){ h1{font-size:1.3rem;} }
  </style>
</head>
<body>

<h1 id="titleText">Tracking Goods</h1>
<div class="container">

  <label id="labelCode">Product Code</label>
  <input id="kodeInput" placeholder="Scan or type..." />
  <button onclick="startScanner('kode')">ðŸ“· Scan Product Code</button>

  <label id="labelLocation">Location</label>
  <input id="lokasiInput" placeholder="Scan or type..." />
  <button onclick="startScanner('lokasi')">ðŸ“· Scan Location</button>

  <button onclick="saveRecord()" id="saveBtn">ðŸ’¾ Save</button>

  <input id="searchBox" placeholder="Search..." oninput="searchData()" />

  <button onclick="exportCSV()">ðŸ“¤ Export CSV</button>

  <table>
    <thead>
      <tr><th id="thCode">Code</th><th id="thLoc">Location</th><th id="thTime">Updated</th><th>Action</th></tr>
    </thead>
    <tbody id="dataList"></tbody>
  </table>

</div>

<!-- HISTORY POPUP -->
<div id="historyModal">
  <div id="historyBox">
    <h3 id="historyTitle"></h3>
    <table>
      <thead><tr><th>Location</th><th>Time</th></tr></thead>
      <tbody id="historyBody"></tbody>
    </table>
    <button id="closeHistory" onclick="closeHistory()">Close</button>
  </div>
</div>

<!-- ZXING CAMERA SCANNER -->
<script src="https://unpkg.com/@zxing/library@0.18.6"></script>
<!-- SUPABASE CLIENT -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
// ===================== LANGUAGE SUPPORT =====================
let currentLang = "EN";
const textMap = {
  EN:{title:"Tracking Goods", labelCode:"Product Code", labelLocation:"Location", save:"Save", code:"Code", loc:"Location", updated:"Updated"},
  NL:{title:"Goederen Volgen", labelCode:"Productcode", labelLocation:"Locatie", save:"Opslaan", code:"Code", loc:"Locatie", updated:"Bijgewerkt"}
};
function setLang(lang){ currentLang = lang; const t=textMap[lang]; 
  titleText.textContent=t.title;
  labelCode.textContent=t.labelCode;
  labelLocation.textContent=t.labelLocation;
  saveBtn.textContent="ðŸ’¾ "+t.save;
  thCode.textContent=t.code;
  thLoc.textContent=t.loc;
  thTime.textContent=t.updated;
}
setLang("EN");

// ===================== SUPABASE INIT =====================
// GANTI URL INI DENGAN YANG BENAR DARI DASHBOARD SUPABASE
const SUPABASE_URL = "https://ifynrranqixyoxombfck.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmeW5ycmFucWl4eW94b21iZmNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNjgwNzIsImV4cCI6MjA3ODc0NDA3Mn0.UqDQd0rrE4vsYjjj5hHNKsBU3c62lgvNjYp4uUEu2GY";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ===================== SAVE RECORD =====================
async function saveRecord(){
  const kode = kodeInput.value.trim(); const lokasi = lokasiInput.value.trim(); if(!kode||!lokasi){alert("Fill both fields");return;}

  await db.from("goods_summary").upsert({kode,lokasi,updated_at:new Date().toISOString()},{onConflict:"kode"});
  await db.from("goods_history").insert({kode,lokasi,time:new Date().toISOString()});

  kodeInput.value=""; lokasiInput.value="";
  loadData();
}

// ===================== LOAD SUMMARY =====================
async function loadData(){
  let {data, error} = await db.from("goods_summary").select("*").order("updated_at",{ascending:false});
  if(error){ console.error(error); return; }
  renderTable(data || []);
}

function renderTable(rows){
  dataList.innerHTML="";
  if(!rows.length){ dataList.innerHTML = "<tr><td colspan='4'>No data</td></tr>"; return; }

  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.kode}</td><td>${r.lokasi}</td><td>${new Date(r.updated_at).toLocaleString()}</td>
      <td class='actions'><button onclick="openHistory('${r.kode}')">ðŸ“œ</button></td>`;
    dataList.appendChild(tr);
  });
}

// ===================== SEARCH REALTIME =====================
async function searchData(){
  const q = searchBox.value.toLowerCase();
  if(!q){ loadData(); return; }

  let {data} = await db.from("goods_summary").select("*");
  data = data?.filter(d => d.kode.toLowerCase().includes(q) || d.lokasi.toLowerCase().includes(q)) || [];
  renderTable(data);
}

// ===================== HISTORY POPUP =====================
async function openHistory(kode){
  historyModal.style.display="flex";
  historyTitle.textContent = `History: ${kode}`;
  let {data} = await db.from("goods_history").select("*").eq("kode",kode).order("time",{ascending:false});
  historyBody.innerHTML = (data||[]).map(r=>`<tr><td>${r.lokasi}</td><td>${new Date(r.time).toLocaleString()}</td></tr>`).join("");
}
function closeHistory(){ historyModal.style.display="none"; }

// ===================== EXPORT CSV =====================
async function exportCSV(){
  let {data} = await db.from("goods_summary").select("*");
  let csv = "kode,lokasi,updated_at\n" + (data||[]).map(r=>`${r.kode},${r.lokasi},${r.updated_at}`).join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download="tracking_data.csv"; a.click();
}

// ===================== CAMERA SCAN =====================
let codeReader = new ZXing.BrowserMultiFormatReader();
async function startScanner(target){
  try{
    const devices = await codeReader.listVideoInputDevices();
    if(!devices || devices.length===0){ alert("No camera found or permission denied."); return; }

    let backCam = devices.find(d=>d.label.toLowerCase().includes("back")) || devices[0];

    createPreview();

    codeReader.decodeOnceFromVideoDevice(backCam.deviceId, "video-preview")
      .then(result=>{
        if(target==="kode") kodeInput.value=result.text;
        if(target==="lokasi") lokasiInput